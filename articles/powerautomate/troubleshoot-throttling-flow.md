---
title: 低速フローのトラブル シューティング
date: 2023-02-03 00:00
tags:
  - Power Automate
  - Cloud flows
---

# タイトル

こんにちは、Power Platform サポートの瀬戸です。
今回は、「クラウド フローの処理がいつまで経っても終わらない」ときに試していただける改善策をご案内いたします。

<!-- more -->

Power Automate には、サービスを皆さまへ安定的に提供するため、
単位時間あたりにフローを実行できる量や、処理できるデータサイズに制限が設けられています。
中でも1番抵触しやすい制限として、「24 時間あたりのアクション要求数」の制限に抵触し、フローが低速状態となってしまうケースが多くあります。
そこで今回は、フローが低速状態となることを避けるために実施いただける改善策をご案内いたします。



## 設計
1度に大量のデータを処理しない。1時間に100件とかにする



・フィルタークエリを使って取得件数を絞る。
・filterを使ってループ件数を予め減らす。
・列を絞ってデータ量を減らす。
・XPathを使って集計する。
・待機を入れて実行を遅くする。
　→スケジュールトリガー(1時間に1回など)や自動トリガーが高頻度で起動する場合は効果が薄そう）
　→コネクタの制限とか、短時間あたりの制限を避けるには効果がある。

## 集計に XPath を活用する
　2302160060001327

例えば、下図のように、数値の列を持つ SharePoint リストがあります。
![](troubleshoot-throttling-flow/image01.png)

この amount1、amount2 の列の合計を求めたい場合、素直に考えると Apply to each で数を集計することを考えます。
しかしこの方法では、集計するだけで少なくとも リストの行数 × 集計したい列の数 の回数アクションが実行されます。

※ この辺に Apply to each の例

しかし、残念ながら Power Automate には配列を集計するような機能はご提供がありません。
それでもなるべく少ないアクション数で集計をしたい場合は、XPath の関数の機能を活用いただけます。

XPath は XML という形式のデータの位置を指定できる言語です。関数も用意されていて、集計 (sum) や数のカウント (count) ができます。
Power Automate 上ではデータは基本的に JSON 形式で扱われますが、JSON 形式を XML 形式へ変換する関数のご用意がございます。

以下に、XML と XPath を使って、先ほどの SharePoint リストを集計するサンプルを記載いたします。
Apply to each を使用しないので、行数が増えても実行されるアクション数が増えません。

※フロー全体図

(1) 複数の項目の取得
SharePoint コネクタの「複数の項目の取得」アクションを使用し、リストを取得します。

|パラメータ名|値|
|---|---|
|サイトのアドレス|リストがあるサイトを選択します。|
|リスト名|リストの名前を選択します。|

(2) 選択
データ操作コネクタの「選択」アクションを使用し、集計に必要な列のみの配列を作成します。

|パラメータ名|値|
|---|---|
|開始|「(1) 複数の項目の取得」アクションの出力「value」|
|マップ|集計に必要な列の列名と値を指定します。|

この例では amount1 列と amount2 列を集計したいので、その2つを指定します。
	amount1	「(1) 複数の項目の取得」アクションの出力「amount1」
	amount2	「(1) 複数の項目の取得」アクションの出力「amount2」

(3) 作成1
データ操作コネクタの「作成」アクションを使用し、配列をXML へ変換できる形へ整形します。

|パラメータ名|値|
|---|---|
|入力|`{"root": {"numbers":「(2) 選択」アクションの出力  }}`|

(4) 作成2
データ操作コネクタの「作成」アクションを使用し、先のアクションの出力を XML へ変換します。

|パラメータ名|値|
|---|---|
|入力|以下を式として入力：<br>`xml(outputs('作成1'))`　※1|

※1 「作成1」は「(3) 作成1」アクションのアクション名です。

参考 (xml 関数)：https://learn.microsoft.com/ja-jp/azure/logic-apps/workflow-definition-language-functions-reference#xml

(5) 作成-amount1
データ操作コネクタの「作成」アクションを使用し、XML へ変換した内容と XPath を使用して amount1 列の集計を求めます。
|パラメータ名|値|
|---|---|
|入力|以下を式として入力：<br>`xpath(outputs('作成2'), 'sum(/root/numbers/amount1)')`　※1|

※1 「作成2」は「(4) 作成2」アクションのアクション名です。

参考 (xpath 関数)：https://learn.microsoft.com/ja-jp/azure/logic-apps/workflow-definition-language-functions-reference#xpath

(6) 作成-amount2
データ操作コネクタの「作成」アクションを使用し、amount1 と同じく amount2 の集計を求めます。
|パラメータ名|値|
|---|---|
|入力|以下を式として入力：<br>`xpath(outputs('作成2'), 'sum(/root/numbers/amount2)')`　※1|

※1 「作成2」は「(4) 作成2」アクションのアクション名です。

実行結果：





## 最後に